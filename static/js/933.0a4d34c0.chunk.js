(self.webpackChunkhk_independent_bus_eta=self.webpackChunkhk_independent_bus_eta||[]).push([[933],{1268:(t,e,n)=>{"use strict";n.d(e,{Z:()=>l});var o=n(7829),r=n(5309),a=n(9980),c=n(7313),i=n(6060),s=n(6417);const l=()=>{const{compassPermission:t,setCompassPermission:e}=(0,c.useContext)(i.ZP),n=(0,c.useCallback)((()=>{(0,a.ZK)().then((t=>{e(t)}))}),[e]);return a.G6&&"granted"!==t?(0,s.jsx)("div",{className:"leaflet-bottom leaflet-right",children:(0,s.jsx)(o.Z,{sx:u,className:"leaflet-control leaflet-bar",onClick:n,children:(0,s.jsx)(r.Z,{sx:{p:"3px",color:"black"}})})}):(0,s.jsx)(s.Fragment,{})},u={background:"white",width:32,height:32,marginBottom:"57px !important",marginRight:"5px !important",display:"flex",justifyContent:"center",alignItems:"center"}},8379:(t,e,n)=>{"use strict";n.d(e,{Z:()=>p});var o=n(7313),r=n(6060),a=n(5823),c=n(9062),i=n(5594),s=n(7248),l=n.n(s),u=n(9980),d=(n(7686),n(6417));const m=(0,o.forwardRef)(((t,e)=>{let{children:n,...r}=t;const a=(0,o.useRef)(null),i=(0,u.ZP)(100),[s,l]=(0,o.useState)(null);return(0,o.useEffect)((()=>{const t=t=>{try{const e=JSON.parse(t.data);"compass"===(null===e||void 0===e?void 0:e.type)&&l({degree:e.degree,accuracy:e.accuracy})}catch(e){}};return window.addEventListener("message",t),()=>{window.removeEventListener("message",t)}}),[]),(0,o.useEffect)((()=>{l(i)}),[i]),(0,o.useEffect)((()=>{const t=a.current;t&&s&&(t.setRotationAngle(360-s.degree),t.setRotationOrigin("center"))}),[s]),null===s?(0,d.jsx)(d.Fragment,{}):(0,d.jsx)(c.J,{ref:t=>{a.current=t,e&&(e.current=t)},...r,children:n})})),p=()=>{const{geolocation:t,geoPermission:e}=(0,o.useContext)(r.ZP),n=(0,o.useMemo)((()=>g()),[]);return"granted"!==e?null:(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(i.C,{center:(0,a.bf)(t),radius:25}),(0,d.jsx)(m,{rotationOrigin:"center",icon:n,position:(0,a.bf)(t)},"rotated-marker")]})},g=()=>l().divIcon({iconSize:[20,20],iconAnchor:[10,10],className:"self-center"})},933:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>C});var o=n(7313),r=n(4580),a=n(8153),c=n(9062),i=n(9024),s=n(7828),l=n(7096),u=n(7248),d=n.n(u);const m=(0,i.Au)((function(t,e){let{data:n,...o}=t;const r=new u.GeoJSON(n,o);return(0,s.O)(r,(0,l.sj)(e,{overlayContainer:r}))}),(function(t,e,n){e.style!==n.style&&(null==e.style?t.resetStyle():t.setStyle(e.style))}));var p=n(7829),g=n(4511),h=n(6060),v=n(1171),f=n(6417);const b=(0,v.Z)((0,f.jsx)("path",{d:"M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"}),"MyLocation");var k=n(5823),x=n(8379),y=n(1268);const M=t=>{let{onClick:e}=t;return(0,f.jsx)("div",{className:"leaflet-bottom leaflet-right",children:(0,f.jsx)(p.Z,{sx:O,className:"leaflet-control leaflet-bar",onClick:e,children:(0,f.jsx)(b,{className:S.centerControl})})})},C=t=>{var e;let{routeId:n,stopIds:i,stopIdx:s,companies:l,onMarkerClick:u}=t;const{geolocation:v,geoPermission:b,updateGeoPermission:C,colorMode:I,db:{stopList:O}}=(0,o.useContext)(h.ZP),{i18n:R}=(0,g.$)(),[Z,_]=(0,o.useState)(null),L=(0,o.useMemo)((()=>i.map((t=>O[t]))),[O,i]),N=((t,e)=>{const[n,r]=(0,o.useState)(null),{db:{routeList:a}}=(0,o.useContext)(h.ZP),{gtfsId:c,bound:i,co:s}=a[t];return(0,o.useEffect)((()=>{let n="";return c?n="".concat(c,"-").concat("I"===i[s[0]]?"I":"O",".json"):s.includes("mtr")&&(n="".concat(t.split("-")[0].toLowerCase(),".json")),fetch("https://hkbus.github.io/route-waypoints/".concat(n)).then((t=>t.json())).then((t=>{r(t)})).catch((()=>{r({features:[{type:"Feature",geometry:{type:"LineString",coordinates:e.reduce(((t,e)=>{let{location:{lat:n,lng:o}}=e;return t.push([o,n]),t}),[])}}],type:"FeatureCollection"})})),()=>{r(null)}}),[t,c,i,s,e]),n})(n,L),z=(0,o.useRef)({initialCenter:L[s]?L[s].location:(0,k.bf)(),currentStopCenter:L[s]?L[s].location:(0,k.bf)(),center:L[s]?L[s].location:(0,k.bf)(),isFollow:!1,stops:L,stopIdx:s});(0,o.useEffect)((()=>{let t,e;t=z.current.stops===L&&z.current.stopIdx===s&&z.current.isFollow,e=z.current.stops===L&&z.current.stopIdx===s&&t?v:L[s]?L[s].location:(0,k.bf)();const n=z.current.center;var o,r;n===e||(0,k.pB)(e,n)||(z.current.stops!==L?null===(o=z.current.map)||void 0===o||o.setView(e):null===(r=z.current.map)||void 0===r||r.flyTo(e));z.current={...z.current,center:e,currentStopCenter:L[s]?L[s].location:(0,k.bf)(),stops:L,stopIdx:s,isFollow:t}}),[L,s,v]),(0,o.useEffect)((()=>{if(Z){z.current={...z.current,map:Z};const t=()=>{z.current={...z.current,center:z.current.currentStopCenter,isFollow:!1}};return null===Z||void 0===Z||Z.on({dragend:t,dragstart:t}),null===Z||void 0===Z||Z.setView(z.current.center),null===Z||void 0===Z||Z.invalidateSize(),()=>{Z.off({dragstart:t,dragend:t})}}}),[Z]);const E=(0,o.useCallback)((()=>{var t;"granted"===b?(null===(t=z.current.map)||void 0===t||t.flyTo(v),z.current={...z.current,center:v,isFollow:!0}):"denied"!==b&&(z.current={...z.current,isFollow:!0},C("opening"))}),[b,v,C]);return(0,f.jsx)(p.Z,{id:"route-map",sx:A,children:(0,f.jsxs)(r.h,{center:z.current.initialCenter,zoom:16,scrollWheelZoom:!1,className:S.mapContainer,ref:_,children:[(0,f.jsx)(a.I,{crossOrigin:"anonymous",maxZoom:d().Browser.retina?20:19,maxNativeZoom:18,keepBuffer:10,updateWhenIdle:!1,attribution:'\xa9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors \xa9 <a href="https://carto.com/attributions">CARTO</a>',url:"light"===I?"https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png":"https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png"}),L.map(((t,e)=>(0,f.jsx)(c.J,{position:t.location,icon:j({active:e===s,passed:e<s,companies:l}),alt:"".concat(e,". ").concat(t.name[R.language]),eventHandlers:{click:t=>{u(e,t)}}},"".concat(t.location.lng,"-").concat(t.location.lat,"-").concat(e)))),(null===N||void 0===N||null===(e=N.features)||void 0===e?void 0:e.length)&&(0,f.jsx)(m,{data:N,style:w},null===N||void 0===N?void 0:N.timeStamp),(0,f.jsx)(x.Z,{}),(0,f.jsx)(M,{onClick:E}),(0,f.jsx)(y.Z,{})]})})},w=function(t){return{color:"#FF9090",weight:4}},j=t=>{let{active:e,passed:n,companies:o}=t;return"mtr"===o[0]||o.includes("lightRail")?d().divIcon({iconSize:[20,20],iconAnchor:[10,10],className:"".concat(S.mtrMarker," ").concat(S.marker," ").concat(e?S.active:""," ").concat(n?S.passed:"")}):o[0].startsWith("gmb")?d().divIcon({iconSize:[30,30],iconAnchor:[15,30],className:"".concat(S.gmbMarker," ").concat(S.marker," ").concat(e?S.active:""," ").concat(n?S.passed:"")}):o.includes("lrtfeeder")?d().divIcon({iconSize:[30,30],iconAnchor:[15,30],className:"".concat(S.lrtfeederMarker," ").concat(S.marker," ").concat(e?S.active:""," ").concat(n?S.passed:"")}):o.includes("nlb")?d().divIcon({iconSize:[30,30],iconAnchor:[15,30],className:"".concat(S.nlbMarker," ").concat(S.marker," ").concat(e?S.active:""," ").concat(n?S.passed:"")}):o.includes("ctb")&&o.includes("kmb")?d().divIcon({iconSize:[30,30],iconAnchor:[15,30],className:"".concat(S.jointlyMarker," ").concat(S.marker," ").concat(e?S.active:""," ").concat(n?S.passed:"")}):o.includes("ctb")?d().divIcon({iconSize:[30,30],iconAnchor:[15,30],className:"".concat(S.ctbMarker," ").concat(S.marker," ").concat(e?S.active:""," ").concat(n?S.passed:"")}):d().divIcon({iconSize:[30,30],iconAnchor:[15,30],className:"".concat(S.kmbMarker," ").concat(S.marker," ").concat(e?S.active:""," ").concat(n?S.passed:"")})},I="routeMap",S={mapContainerBox:"".concat(I,"-mapContainerBox"),mapContainer:"".concat(I,"-mapContainer"),centerControl:"".concat(I,"-centerControl"),marker:"".concat(I,"-marker"),mtrMarker:"".concat(I,"-mtrMarker"),gmbMarker:"".concat(I,"-gmbMarker"),ctbMarker:"".concat(I,"-ctbMarker"),jointlyMarker:"".concat(I,"-jointlyMarker"),lrtfeederMarker:"".concat(I,"-lrtfeederMarker"),nlbMarker:"".concat(I,"-nlbMarker"),kmbMarker:"".concat(I,"-kmbMarker"),active:"".concat(I,"-active"),passed:"".concat(I,"-passed")},A={height:"35vh",filter:t=>"dark"===t.palette.mode?"brightness(0.8)":"none",["& .".concat(S.mapContainer)]:{height:"35vh"},["& .".concat(S.mtrMarker)]:{backgroundImage:"url(/img/mtr.svg)"},["& .".concat(S.gmbMarker)]:{backgroundImage:"url(/img/minibus.svg)"},["& .".concat(S.ctbMarker)]:{backgroundImage:"url(/img/bus_ctb.svg)"},["& .".concat(S.jointlyMarker)]:{backgroundImage:"url(/img/bus_jointly.svg)"},["& .".concat(S.lrtfeederMarker)]:{backgroundImage:"url(/img/bus_lrtfeeder.svg)"},["& .".concat(S.nlbMarker)]:{backgroundImage:"url(/img/bus_nlb.svg)"},["& .".concat(S.kmbMarker)]:{backgroundImage:"url(/img/bus_kmb.svg)"},["& .".concat(S.active)]:{animation:"blinker 1.5s infinite"},["& .".concat(S.passed)]:{filter:"grayscale(100%)"},"& .self-center":{backgroundImage:"url(/img/self.svg)",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",transition:"transform 0.1s ease-out",transformOrigin:"center"}},O={background:"white",width:32,height:32,marginBottom:"20px !important",marginRight:"5px !important",display:"flex",justifyContent:"center",alignItems:"center",["& .".concat(S.centerControl)]:{padding:"3px",color:"black"}}},5309:(t,e,n)=>{"use strict";n.d(e,{Z:()=>a});var o=n(1171),r=n(6417);const a=(0,o.Z)((0,r.jsx)("path",{d:"M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.19 12.19L6 18l3.81-8.19L18 6l-3.81 8.19z"}),"Explore")},7686:()=>{!function(){var t=L.Marker.prototype._initIcon,e=L.Marker.prototype._setPos,n="msTransform"===L.DomUtil.TRANSFORM;L.Marker.addInitHook((function(){var t=this.options.icon&&this.options.icon.options&&this.options.icon.options.iconAnchor;t&&(t=t[0]+"px "+t[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||t||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0,this.on("drag",(function(t){t.target._applyRotation()}))})),L.Marker.include({_initIcon:function(){t.call(this)},_setPos:function(t){e.call(this,t),this._applyRotation()},_applyRotation:function(){this.options.rotationAngle&&(this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,n?this._icon.style[L.DomUtil.TRANSFORM]="rotate("+this.options.rotationAngle+"deg)":this._icon.style[L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(t){return this.options.rotationAngle=t,this.update(),this},setRotationOrigin:function(t){return this.options.rotationOrigin=t,this.update(),this}})}()},9980:(t,e,n)=>{"use strict";n.d(e,{G6:()=>s,ZK:()=>i,ZP:()=>c});var o=n(7313),r=n(2061),a=n.n(r);const c=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20;const e=(0,o.useRef)(!1),[n,r]=(0,o.useState)(null),c=(0,o.useMemo)((()=>a()((t=>{r(t)}),Math.max(5,t))),[]);return(0,o.useEffect)((()=>{const t=t=>{t.absolute&&(e.current=!0),"undefined"!==typeof t.webkitCompassHeading?c({degree:360-t.webkitCompassHeading,accuracy:t.webkitCompassAccuracy}):t.absolute===e.current&&c(null!==t.alpha?{degree:t.alpha,accuracy:0}:null)};return window.addEventListener("deviceorientationabsolute",t),window.addEventListener("deviceorientation",t),()=>{window.removeEventListener("deviceorientationabsolute",t),window.removeEventListener("deviceorientation",t)}}),[]),n},i=()=>{const t=Promise.resolve("granted");return s&&"undefined"!==typeof DeviceOrientationEvent&&"function"===typeof(null===DeviceOrientationEvent||void 0===DeviceOrientationEvent?void 0:DeviceOrientationEvent.requestPermission)?DeviceOrientationEvent.requestPermission():t},s=(()=>{try{return Boolean(navigator&&navigator.userAgent&&navigator.userAgent.includes("Safari/")&&!(navigator.userAgent.includes("Chrome/")||navigator.userAgent.includes("Chromium/")))}catch(t){return!1}})()}}]);